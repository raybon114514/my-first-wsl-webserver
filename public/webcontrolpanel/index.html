<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-DB Control Panel</title>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; background-color: #f4f4f9; }
        
        /* 雙層側邊欄設計 */
        #sidebar-db { width: 150px; background-color: #222; color: #fff; overflow-y: auto; display: flex; flex-direction: column; }
        #sidebar-table { width: 200px; background-color: #2c3e50; color: #fff; overflow-y: auto; border-left: 1px solid #444; }
        
        .section-title { padding: 15px; font-size: 0.9rem; color: #888; text-transform: uppercase; border-bottom: 1px solid #444; }
        
        .nav-btn {
            padding: 15px; border: none; background: none; color: #ccc; 
            text-align: left; cursor: pointer; width: 100%; transition: 0.2s;
            border-bottom: 1px solid #333;
        }
        .nav-btn:hover { background-color: #444; color: white; }
        .nav-btn.active { background-color: #007bff; color: white; } /* 選中 DB */
        .nav-btn.table-active { background-color: #1abc9c; color: white; } /* 選中 Table */

        #main { flex: 1; padding: 20px; overflow: auto; }
        
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background-color: #eee; }
    </style>
</head>
<body>

    <div id="sidebar-db">
        <div class="section-title">Databases</div>
        <div id="db-list"></div>
    </div>

    <div id="sidebar-table">
        <div class="section-title">Tables</div>
        <div id="table-list" style="padding:10px; font-size:0.9rem; color:#aaa;">請先選擇資料庫</div>
    </div>

    <div id="main">
        <h2 id="current-path">Dashboard</h2>
        <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            <textarea id="sql-input" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 3px; font-family: monospace;" placeholder="在這裡輸入 SQL 指令... (例如: SELECT * FROM users)"></textarea>
            <div style="margin-top: 10px; text-align: right;">
                <button onclick="runSQL()" style="padding: 8px 20px; background-color: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer;">執行 SQL</button>
            </div>
        </div>
        <div id="data-container"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let currentDB = '';

        // 1. 初始化：載入資料庫列表
        async function loadDatabases() {
            const res = await fetch(`${API_BASE}/databases`);
            const json = await res.json();
            
            const container = document.getElementById('db-list');
            container.innerHTML = '';
            
            json.databases.forEach(db => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.textContent = db;
                btn.onclick = () => selectDatabase(db, btn);
                container.appendChild(btn);
            });
        }

        // 2. 選取資料庫 -> 載入 Tables
        async function selectDatabase(dbName, btnElement) {
            currentDB = dbName;
            
            // UI 更新
            document.querySelectorAll('#sidebar-db .nav-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            document.getElementById('current-path').textContent = `DB: ${dbName}`;
            document.getElementById('table-list').innerHTML = '載入中...';
            document.getElementById('data-container').innerHTML = '';

            try {
                const res = await fetch(`${API_BASE}/tables?db=${dbName}`);
                const json = await res.json();
                
                const container = document.getElementById('table-list');
                container.innerHTML = '';

                if(json.tables.length === 0) {
                    container.innerHTML = '<div style="padding:10px">無資料表</div>';
                    return;
                }

                json.tables.forEach(table => {
                    const btn = document.createElement('button');
                    btn.className = 'nav-btn';
                    btn.textContent = table;
                    btn.onclick = () => loadData(table, btn);
                    container.appendChild(btn);
                });
            } catch (err) {
                console.error(err);
            }
        }

        // 3. 選取 Table -> 載入資料
        async function loadData(tableName, btnElement) {
            // UI 更新
            document.querySelectorAll('#sidebar-table .nav-btn').forEach(b => b.classList.remove('table-active'));
            btnElement.classList.add('table-active');
            document.getElementById('current-path').textContent = `DB: ${currentDB} > Table: ${tableName}`;
            document.getElementById('data-container').innerHTML = '載入資料中...';

            try {
                const res = await fetch(`${API_BASE}/data?db=${currentDB}&table=${tableName}`);
                const json = await res.json();
                
                const data = json.data;
                if (data.length === 0) {
                    document.getElementById('data-container').innerHTML = '此表為空';
                    return;
                }

                let html = '<table><thead><tr>';
                const headers = Object.keys(data[0]);
                headers.forEach(h => html += `<th>${h}</th>`);
                html += '</tr></thead><tbody>';
                data.forEach(row => {
                    html += '<tr>';
                    headers.forEach(h => html += `<td>${row[h]}</td>`);
                    html += '</tr>';
                });
                html += '</tbody></table>';

                document.getElementById('data-container').innerHTML = html;
            } catch (err) {
                document.getElementById('data-container').innerHTML = `<p style="color:red">${err.message}</p>`;
            }
        }
        
        // 執行使用者輸入的 SQL
        async function runSQL() {
            const sql = document.getElementById('sql-input').value;
            if (!sql) {
                alert("請輸入指令");
                return;
            }

            // 顯示載入中
            document.getElementById('data-container').innerHTML = '執行中...';

            try {
                const res = await fetch(`${API_BASE}/sql`, {
                    method: 'POST', // 使用 POST 方法
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        sql: sql,
                        db: currentDB // 把目前選中的資料庫也傳過去
                    })
                });

                const json = await res.json();

                if (json.error) {
                    // 如果 SQL 語法錯誤 (例如打錯字)
                    document.getElementById('data-container').innerHTML = `<p style="color:red; font-weight:bold;">執行錯誤：${json.error}</p>`;
                    return;
                }

                // 顯示結果
                renderResult(json.result);

            } catch (err) {
                console.error(err);
                document.getElementById('data-container').innerHTML = '系統錯誤';
            }
        }

        // 抽離出一個共用的渲染函式 (讓 loadData 和 runSQL 都可以用)
        function renderResult(data) {
            const container = document.getElementById('data-container');
            
            // 狀況 1: 如果是空陣列 (查無資料)
            if (Array.isArray(data) && data.length === 0) {
                container.innerHTML = '查詢成功，但沒有資料。';
                return;
            }

            // 狀況 2: 如果是操作結果 (例如 INSERT/UPDATE 成功)
            // MySQL 的操作結果通常會有 affectedRows 屬性
            if (!Array.isArray(data) && data.affectedRows !== undefined) {
                container.innerHTML = `
                    <div style="color: green; padding: 10px; border: 1px solid green; background: #e8f5e9;">
                        <strong>執行成功！</strong><br>
                        影響筆數: ${data.affectedRows}<br>
                        訊息: ${data.info || '無'}
                    </div>`;
                return;
            }

            // 狀況 3: 一般 SELECT 查詢結果 (陣列)
            if (Array.isArray(data)) {
                let html = '<table><thead><tr>';
                const headers = Object.keys(data[0]);
                headers.forEach(h => html += `<th>${h}</th>`);
                html += '</tr></thead><tbody>';
                data.forEach(row => {
                    html += '<tr>';
                    headers.forEach(h => html += `<td>${row[h]}</td>`);
                    html += '</tr>';
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            }
        }

        loadDatabases();
    </script>
</body>
</html>